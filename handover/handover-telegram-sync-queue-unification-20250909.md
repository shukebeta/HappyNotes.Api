# Telegram åŒæ­¥é˜Ÿåˆ—åŒ–ç»Ÿä¸€ - äº¤æ¥æ–‡æ¡£
**æ—¶é—´**: 2025-09-09  
**çŠ¶æ€**: è¿›è¡Œä¸­ - éœ€è¦ç»§ç»­å®Œæˆ SyncNewNote å’Œ SyncEditNote çš„é˜Ÿåˆ—åŒ–

## ğŸ¯ é¡¹ç›®ç›®æ ‡
ç»Ÿä¸€æ‰€æœ‰ Telegram åŒæ­¥æ“ä½œä½¿ç”¨ Redis é˜Ÿåˆ—ï¼Œç¡®ä¿æ¶æ„ä¸€è‡´æ€§å’Œå¯é æ€§ã€‚

## âœ… å·²å®Œæˆçš„å·¥ä½œ

### 1. ä¿®å¤äº†ç”¨æˆ·æŠ¥å‘Šçš„åˆ é™¤åŒæ­¥é—®é¢˜
**é—®é¢˜**: åˆ é™¤ç¬”è®°çš„ Telegram åŒæ­¥å¤±è´¥  
**æ ¹å› **: `SyncDeleteNote` ä½¿ç”¨ç›´æ¥ API è°ƒç”¨è€Œéé˜Ÿåˆ—  
**è§£å†³æ–¹æ¡ˆ**:
- ä¿®æ”¹ `TelegramSyncNoteService.SyncDeleteNote` ä½¿ç”¨ `EnqueueSyncTask`
- å¢å¼º `TelegramSyncHandler.ProcessDeleteAction` å¤„ç†æˆåŠŸåæ¸…ç† `TelegramMessageIds`
- æ·»åŠ  `RemoveMessageIdFromNote` æ–¹æ³•ç²¾ç¡®ç§»é™¤æŒ‡å®šé¢‘é“çš„æ¶ˆæ¯ID

### 2. ä¼˜åŒ–é˜Ÿåˆ—æ€§èƒ½ - è§£å†³20ç§’å»¶è¿Ÿé—®é¢˜
**é—®é¢˜**: é˜Ÿåˆ—å¤„ç†å»¶è¿Ÿ20ç§’ï¼Œç”¨æˆ·ä½“éªŒå·®  
**æ ¹å› **: `PollingInterval` è®¾ç½®ä¸º30ç§’  
**è§£å†³æ–¹æ¡ˆ**: 
- ä¿®æ”¹ `appsettings.json` ä¸­ `PollingInterval` ä» `00:00:30` æ”¹ä¸º `00:00:02`
- å»¶è¿Ÿä» 20+ ç§’é™ä½åˆ° 2-4 ç§’ï¼Œå®ç°å‡†å®æ—¶åŒæ­¥

### 3. ä¿®å¤ ProcessDelayedTasks åŸå­æ€§é—®é¢˜ (GåŒäº‹ä»£ç å®¡æŸ¥)
**é—®é¢˜**: ä½¿ç”¨ MULTI/EXEC äº‹åŠ¡å­˜åœ¨ç«æ€æ¡ä»¶å’Œæ€§èƒ½é—®é¢˜  
**è§£å†³æ–¹æ¡ˆ**:
- å®ç° Lua è„šæœ¬ `ProcessDelayedTasksScript` è¿›è¡ŒåŸå­æ‰¹é‡å¤„ç†
- æ·»åŠ  batch limit (100) é˜²æ­¢å¤§é‡ç§¯å‹ä»»åŠ¡å‹å® Redis
- æ–°å¢é›†æˆæµ‹è¯•éªŒè¯åŸå­æ€§: `DelayedTaskProcessingTests.cs`

### 4. æ”¹è¿›å¼€å‘ä½“éªŒ
- **Pre-commit hook**: è‡ªåŠ¨æ ¼å¼åŒ–ä»£ç è€Œä¸æ˜¯é˜»æ­¢æäº¤
- **GitHub Actions**: ä¿®å¤ upload-artifact v3 åºŸå¼ƒè­¦å‘Šï¼Œå‡çº§åˆ° v4

## ğŸš§ è¿›è¡Œä¸­çš„å·¥ä½œ

### å½“å‰ Telegram åŒæ­¥çŠ¶æ€åˆ†æ
1. **âœ… SyncDeleteNote** - å·²ä½¿ç”¨é˜Ÿåˆ—ï¼Œ2ç§’å»¶è¿Ÿ
2. **âš ï¸ SyncNewNote** - æ··åˆæ¨¡å¼ï¼šç›´æ¥è°ƒç”¨æˆåŠŸåˆ™ç¬é—´å®Œæˆï¼Œå¤±è´¥æ‰ä½¿ç”¨é˜Ÿåˆ—
3. **âŒ SyncEditNote** - å®Œå…¨ç›´æ¥è°ƒç”¨ï¼ŒåŒ…å«å¤æ‚ä¸šåŠ¡é€»è¾‘ï¼Œç¬é—´å®Œæˆ

### ç”¨æˆ·ä½“éªŒé—®é¢˜
- **ä¸ä¸€è‡´**: æ–°å»º/ä¿®æ”¹ç¬é—´ï¼Œåˆ é™¤éœ€è¦2ç§’
- **æµ‹è¯•å›°éš¾**: æ— æ³•ç»Ÿä¸€æµ‹è¯•é˜Ÿåˆ—æœºåˆ¶

## ğŸ” å…³é”®æŠ€æœ¯å‘ç°

### SyncEditNote çš„å¤æ‚æ€§åˆ†æ
è¯¥æ–¹æ³•åŒ…å«ç²¾ç»†çš„ä¸šåŠ¡é€»è¾‘ï¼Œ**ä¸èƒ½ç®€å•åˆ é™¤**ï¼š

1. **é¢‘é“å·®å¼‚åˆ†æ**: `_GetRequiredChannelData` åˆ†æéœ€è¦åˆ é™¤/æ›´æ–°/åˆ›å»ºçš„é¢‘é“
2. **æ™ºèƒ½æ›´æ–°ç­–ç•¥**: 
   - å†…å®¹ â‰¤ 4096å­—ç¬¦: ä½¿ç”¨ `EditMessageAsync` 
   - å†…å®¹ > 4096å­—ç¬¦: åˆ é™¤åé‡æ–°å‘é€
3. **é™çº§å¤„ç†**: Markdown å¤±è´¥æ—¶é™çº§ä¸ºçº¯æ–‡æœ¬
4. **çŠ¶æ€ç®¡ç†**: ç²¾ç¡®æ›´æ–° `TelegramMessageIds` åæ˜ å®é™…åŒæ­¥çŠ¶æ€

### SyncNewNote çš„é•¿åº¦åˆ¤æ–­
ç”¨æˆ·æé†’ï¼šå³ä½¿æ–°å»ºæ“ä½œä¹Ÿæœ‰é•¿åº¦åˆ¤æ–­é€»è¾‘ï¼Œéœ€è¦ä¿æŒã€‚

## ğŸ“‹ ä¸‹ä¸€æ­¥å·¥ä½œè®¡åˆ’

### 1. SyncNewNote é˜Ÿåˆ—åŒ– (ç›¸å¯¹ç®€å•)
```csharp
// å½“å‰æ··åˆæ¨¡å¼
try {
    var messageId = await _SentNoteToChannel(...);  // ç›´æ¥è°ƒç”¨
} catch {
    await EnqueueSyncTask(...);  // å¤±è´¥æ‰ç”¨é˜Ÿåˆ—
}

// ç›®æ ‡ï¼šçº¯é˜Ÿåˆ—æ¨¡å¼  
await EnqueueSyncTask(note, fullContent, string.Empty, channelId, "CREATE");
```
- ç§»é™¤æ··åˆé€»è¾‘ï¼Œç»Ÿä¸€ä½¿ç”¨é˜Ÿåˆ—
- ç§»é™¤ç«‹å³æ›´æ–° `TelegramMessageIds` çš„ä»£ç 
- ç¡®ä¿ `ProcessCreateAction` å¤„ç†é•¿åº¦åˆ¤æ–­é€»è¾‘

### 2. SyncEditNote é˜Ÿåˆ—åŒ– (å¤æ‚ï¼Œéœ€è°¨æ…)
**ä¿æŒç°æœ‰å†³ç­–é€»è¾‘**ï¼Œä»…æ›¿æ¢ API è°ƒç”¨ä¸ºé˜Ÿåˆ—æ“ä½œï¼š
- `_DeleteMessage` â†’ `EnqueueSyncTask("DELETE")`
- `telegramService.EditMessageAsync` â†’ `EnqueueSyncTask("UPDATE")`  
- `_SentNoteToChannel` â†’ `EnqueueSyncTask("CREATE")`

**å…³é”®ç‚¹**:
- âœ… ä¿ç•™ `_GetRequiredChannelData` åˆ†æé€»è¾‘
- âœ… ä¿ç•™é•¿åº¦åˆ¤æ–­å’Œé™çº§ç­–ç•¥  
- âœ… ä¿ç•™é”™è¯¯å¤„ç†é€»è¾‘
- âŒ ç§»é™¤ç«‹å³çŠ¶æ€æ›´æ–°ï¼Œæ”¹ä¸º handler å¼‚æ­¥æ›´æ–°

### 3. Handler å®Œå–„
- **ProcessUpdateAction**: éœ€è¦æ·»åŠ  `task` å‚æ•°æ”¯æŒï¼Œå¤„ç†æˆåŠŸåæ›´æ–°çŠ¶æ€
- **ProcessCreateAction**: âœ… å·²æ·»åŠ  `AddMessageIdToNote`
- **ProcessDeleteAction**: âœ… å·²æ·»åŠ  `RemoveMessageIdFromNote`

## ğŸ—‚ï¸ é‡è¦æ–‡ä»¶å’Œä¿®æ”¹

### ä¸»è¦æ–‡ä»¶
- `src/HappyNotes.Services/TelegramSyncNoteService.cs` - ä¸»è¦æœåŠ¡é€»è¾‘
- `src/HappyNotes.Services/SyncQueue/Handlers/TelegramSyncHandler.cs` - é˜Ÿåˆ—å¤„ç†å™¨
- `src/HappyNotes.Api/appsettings.json` - é…ç½®æ–‡ä»¶
- `src/HappyNotes.Services/SyncQueue/Services/RedisSyncQueueService.cs` - é˜Ÿåˆ—æœåŠ¡

### æ–°å¢æ–‡ä»¶
- `tests/HappyNotes.Services.Tests/SyncQueue/DelayedTaskProcessingTests.cs` - åŸå­æ€§æµ‹è¯•
- `scripts/monitor-staging-deployment.sh` - éƒ¨ç½²ç›‘æ§è„šæœ¬

### é…ç½®å˜æ›´
```json
"Processing": {
  "PollingInterval": "00:00:02",  // ä» 30s æ”¹ä¸º 2s
}
```

## âš ï¸ æ³¨æ„äº‹é¡¹

### çŠ¶æ€ç®¡ç†æ—¶åº
- é˜Ÿåˆ—åŒ–åï¼Œ`TelegramMessageIds` æ›´æ–°å˜ä¸ºå¼‚æ­¥
- å¿…é¡»ç¡®ä¿åªæœ‰åœ¨ Telegram API æˆåŠŸåæ‰æ›´æ–°çŠ¶æ€
- å¤±è´¥çš„ä»»åŠ¡å¯ä»¥é‡è¯•è€Œä¸ä¸¢å¤±çŠ¶æ€

### ä¸šåŠ¡é€»è¾‘å®Œæ•´æ€§
- **ç¦æ­¢ç®€å•åˆ é™¤å¤æ‚é€»è¾‘** - è¿™äº›é€»è¾‘å­˜åœ¨å¿…æœ‰å…¶åŸå› 
- ä¿æŒç°æœ‰çš„æ™ºèƒ½å†³ç­–æœºåˆ¶
- ç¡®ä¿é”™è¯¯å¤„ç†å’Œé™çº§ç­–ç•¥å®Œæ•´

### æµ‹è¯•éªŒè¯
- æµ‹è¯•æ–°å»º/ä¿®æ”¹/åˆ é™¤çš„å®Œæ•´æµç¨‹
- éªŒè¯é•¿å†…å®¹çš„å¤„ç†é€»è¾‘
- ç¡®è®¤å¤±è´¥é‡è¯•æœºåˆ¶æ­£å¸¸

## ğŸš€ é¢„æœŸæ•ˆæœ
- âœ… ç»Ÿä¸€çš„é˜Ÿåˆ—å¤„ç†æ¶æ„
- âœ… ä¸€è‡´çš„2ç§’å‡†å®æ—¶å“åº”
- âœ… å¯é çš„é‡è¯•å’Œé”™è¯¯æ¢å¤
- âœ… å®Œæ•´çš„ç›‘æ§å’Œç®¡ç†èƒ½åŠ›
- âœ… ä¿æŒç°æœ‰ä¸šåŠ¡é€»è¾‘å®Œæ•´æ€§

## ğŸ“ è”ç³»ä¿¡æ¯
å¦‚æœ‰ç–‘é—®ï¼Œå‚è€ƒä»¥å¾€çš„ handover æ–‡æ¡£æˆ–æŸ¥çœ‹ git æäº¤å†å²ä¸­çš„è¯¦ç»†æ³¨é‡Šã€‚

---
*äº¤æ¥æ—¶é—´: 2025-09-09*  
*ä¸‹ä¸€æ­¥: ç»§ç»­å®Œæˆ SyncNewNote å’Œ SyncEditNote çš„è°¨æ…é˜Ÿåˆ—åŒ–*