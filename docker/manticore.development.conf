# Manticore configuration file for HappyNotes

# Data source for notes
source src_notes
{
    type          = mysql
    sql_host      = mysql
    sql_user      = default_user
    sql_pass      = chrd5
    sql_db        = HappyNotes
    sql_port      = 3306
    
    # Main query for initial indexing
    sql_query     = SELECT n.Id, n.UserId, n.IsPrivate, IF(n.IsLong, l.Content, n.Content) AS Content, GROUP_CONCAT(t.Tag) AS Tags, n.CreatedAt, n.UpdatedAt FROM Note n LEFT JOIN LongNote l ON n.Id = l.Id LEFT JOIN NoteTag nt ON n.Id = nt.NoteId LEFT JOIN Tag t ON nt.TagId = t.Id GROUP BY n.Id
    
    # Delta query for updates (new or modified notes)
    sql_query_delta = SELECT n.Id, n.UserId, n.IsPrivate, IF(n.IsLong, l.Content, n.Content) AS Content, GROUP_CONCAT(t.Tag) AS Tags, n.CreatedAt, n.UpdatedAt FROM Note n LEFT JOIN LongNote l ON n.Id = l.Id LEFT JOIN NoteTag nt ON n.Id = nt.NoteId LEFT JOIN Tag t ON nt.TagId = t.Id WHERE n.UpdatedAt > NOW() - INTERVAL 5 MINUTE GROUP BY n.Id
}

# Real-time index for notes
index idx_notes
{
    type          = rt
    source        = src_notes
    path          = /var/lib/manticore/data/notes
    
    # Field definitions for real-time index
    rt_field      = Content
    rt_field      = Tags
    
    # Attributes for filtering and sorting
    rt_attr_uint  = UserId
    rt_attr_uint  = IsPrivate
    rt_attr_timestamp = CreatedAt
    rt_attr_timestamp = UpdatedAt
    
    # Enable field storage for returning full content in results
    stored_fields = Content, Tags
    
    # Morphology and word processing
    morphology    = stem_en
    min_word_len  = 2
    
    # Enable full-text search features
    index_exact_words = 1
    expand_keywords = 1
}

# Indexer settings
indexer
{
    mem_limit     = 512M
}

# Search daemon settings
searchd
{
    listen        = 9306:mysql41
    listen        = 9312:http
    log           = /var/log/manticore/searchd.log
    query_log     = /var/log/manticore/query.log
    pid_file      = /var/run/manticore/searchd.pid
    read_timeout  = 5
    max_children  = 30
    seamless_rotate = 1
    preopen_indexes = 1
    unlink_old    = 1
    
    # Enable delta updates for near real-time indexing
    rt_flush_period = 60
}

# Common settings
common
{
    lemmatizer_base = /usr/share/manticore/morph/
}
